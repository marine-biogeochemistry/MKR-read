<!DOCTYPE html>
<html>
<head>
  <link rel="manifest" href="manifest.json">
  <script src="service-worker.js"></script>
  <title>MKR1010 BLE Listener</title>
</head>
<body>
  <h1>MKR1010 BLE Listener Panel</h1>

  <!-- 🔍 Connect Button -->
  <button onclick="connectAndListen()">🔍 Scan & Connect</button>
  <p id="selectedDevice" style="font-weight:bold;"></p>
  <p id="connectionStatus"></p>

  <h3>💬 Send manual start command (m) to MKR1010</h3>
  <input type="text" id="commandInput" placeholder="Enter command string" />
  <button onclick="sendCommand()">📤 Send Command</button>
  <p id="commandStatus"></p>

  <button onclick="clearBluetoothDisplay()">🧹 Clear Display</button>

  <!-- 📡 Incoming Data Display -->
  <h3>📡 Incoming Bluetooth Data</h3>
  <div id="bluetoothData" style="border:1px solid #ccc;padding:10px;background:#eef;white-space:pre-wrap;"></div>


  <script>
    let bluetoothDevice, commandChar, responseChar, timeChar;

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log("✅ Service Worker registered"))
          .catch(err => console.error("❌ SW registration failed:", err));
      });
    }


    async function sendCommand() {
      const input = document.getElementById("commandInput").value;
      if (!input || !commandChar) {
        document.getElementById("commandStatus").textContent = "⚠️ No input or not connected";
        return;
      }

      try {
        const encoder = new TextEncoder();
        const data = encoder.encode(input);
        await commandChar.writeValue(data);
        console.log(`📤 Sent: ${input}`);
        document.getElementById("commandStatus").textContent = `✅ Sent: "${input}"`;
      } catch (err) {
        console.error("❌ Send failed:", err);
        document.getElementById("commandStatus").textContent = "❌ Failed to send command";
      }
    }


    async function connectAndListen() {
      try {
        bluetoothDevice = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['56616c76-6550-756d-7053-797300000000']
        });

        document.getElementById("selectedDevice").textContent =
          `🔗 Selected: ${bluetoothDevice.name}`;

        const server = await bluetoothDevice.gatt.connect();
        const service = await server.getPrimaryService('56616c76-6550-756d-7053-797300000000');

        // ✅ Get all three characteristics
        commandChar  = await service.getCharacteristic('56414c56-0000-0000-0000-000000000000');
        responseChar = await service.getCharacteristic('4550554d-0000-0000-0000-000000000000');
        timeChar     = await service.getCharacteristic('50535953-0000-0000-0000-000000000000');

        // ✅ Subscribe to notifications
        await responseChar.startNotifications();
        responseChar.addEventListener('characteristicvaluechanged', handleBluetoothData);

        await timeChar.startNotifications();
        timeChar.addEventListener('characteristicvaluechanged', handleBluetoothData);

        document.getElementById("connectionStatus").textContent =
          "✅ Connected and listening to BLE characteristics...";
        console.log("📡 Subscribed to response and time notifications");
      } catch (error) {
        console.error("❌ Connection failed:", error);
        alert("Bluetooth error: " + error.message);
      }
    }

// 📡 Handle incoming data from the MKR1010

      function handleBluetoothData(event) {
        const bytes = new Uint8Array(event.target.value.buffer);
        const decoded = new TextDecoder().decode(bytes);
        const timestamp = new Date().toLocaleTimeString();

        console.log(`📡 [${timestamp}] Received:`, decoded);

        const display = document.getElementById('bluetoothData');
        const line = document.createElement('div');
        line.textContent = `[${timestamp}] ${decoded}`;

        // Prepend newest data
        display.insertBefore(line, display.firstChild);
        // display.appendChild(line);


        // 🔻 Trim excess entries to 50 lines
        while (display.childNodes.length > 50) {
          display.removeChild(display.lastChild);
        }
      }

    function clearBluetoothDisplay() {
      const display = document.getElementById('bluetoothData');
      display.innerHTML = ""; // Clears all data
      console.log("🧹 Display cleared");
    }

  </script>
</body>
</html>